angular.module("SportsensusApp",["ngMaterial","ngRoute","ngCookies","Views"]).config(["$locationProvider","$routeProvider",function($locationProvider,$routeProvider){$locationProvider.hashPrefix("!"),$routeProvider.when("/",{template:"<home-dir></home-dir>"}).when("/infobox/",{template:"<infobox-dir></infobox-dir>"}).when("/login/",{template:"<login-dir></login-dir>"}).otherwise("/")}]).run(["ConfigSrv",function(ConfigSrv){var config=window.appConfig;ConfigSrv.set(config)}]),function(){"use strict";function ApiSrv($rootScope,$http,$q,$cookies,ConfigSrv){function readSidCookie(){return $cookies.get(sidCookieName)}function writeSidCookie(sid){$cookies.put(sidCookieName,sid)}function clearUser(){sid=null,userRights=null}function setUser(_sid,rights){sid=_sid,userRights=rights,writeSidCookie(sid),getTranslations()}function getUser(){return{sid:sid,userRights:userRights}}function prepareRequestData(method,params){var data={jsonrpc:"2.0",method:method,params:params,id:"id"};return data}function auth(par){var d=$q.defer(),params={login:par.login,password:par.password},data=prepareRequestData("auth",params);return $http.post(url,data).then(function(response){response.data.result?(setUser(response.data.result.sid,response.data.result.acl),d.resolve(response)):(clearUser(),d.reject(response))},function(response){clearUser(),d.reject(response)}),d.promise}function checkSession(_sid){var d=$q.defer(),checkedSid=_sid||sid,params={sid:checkedSid},data=prepareRequestData("check_session",params);return $http.post(url,data).then(function(response){response.data.result&&response.data.result.exist?(setUser(checkedSid,response.data.result.acl),d.resolve(response)):(clearUser(),d.reject(response))},function(response){clearUser(),d.reject(response)}),d.promise}function logout(){var d=$q.defer(),params={sid:sid},data=prepareRequestData("logout",params);return $http.post(url,data).then(function(response){clearUser(),response.data.result&&response.data.result.deleted?d.resolve(response):d.reject(response)},function(response){clearUser(),d.reject(response)}),d.promise}function getTranslations(){function loadTranslations(){var data=prepareRequestData("get_translations",{sid:sid});return $http.post(url,data).then(function(result){result.data&&result.data.result&&result.data.result.data?translationsDefer.resolve(result.data.result.data):translationsDefer.reject()},function(result){translationsDefer.reject()})}return translationsDefer||(translationsDefer=$q.defer()),!translationsLoaded&&sid&&loadTranslations(),translationsDefer.promise}function getCount(audience){var d=$q.defer();$rootScope.$broadcast("ApiSrv.countLoading");var data=prepareRequestData("audienceCount",{sid:sid,audience:audience});return $http.post(url,data).then(function(response){response.data.result?(d.resolve(response.data.result),$rootScope.$broadcast("ApiSrv.countLoaded",response.data.result)):(d.reject(response),$rootScope.$broadcast("ApiSrv.countError",response))},function(response){d.reject(response),$rootScope.$broadcast("ApiSrv.countError",response)}),d.promise}function getImageGraph(audience,sportimage){var d=$q.defer(),data=prepareRequestData("info_sportimage",{sid:sid,audience:audience,sportimage:sportimage});return $http.post(url,data).then(function(response){response.data.result&&response.data.result.graph?d.resolve(response.data.result.graph):d.reject(response)},function(response){d.reject(response)}),d.promise}function getInterestGraph(audience,sportinterest){var d=$q.defer(),data=prepareRequestData("info_sportinterest",{sid:sid,audience:audience,sportinterest:sportinterest});return $http.post(url,data).then(function(response){response.data.result&&response.data.result.graph?d.resolve(response.data.result.graph):d.reject(response)},function(response){d.reject(response)}),d.promise}var userRights,proxyURL=ConfigSrv.get().proxyURL||"",url=proxyURL+ConfigSrv.get().apiUrl,sidCookieName="sportsensus_sid",sid=null;checkSession(readSidCookie());var translationsDefer,translationsLoaded=!1,me={getUser:getUser,auth:auth,checkSession:checkSession,logout:logout,getCount:getCount,getImageGraph:getImageGraph,getInterestGraph:getInterestGraph,getTranslations:getTranslations};return me}angular.module("SportsensusApp").factory("ApiSrv",ApiSrv),angular.module("SportsensusApp").run(["ApiSrv",function(ApiSrv){}]),ApiSrv.$inject=["$rootScope","$http","$q","$cookies","ConfigSrv"]}(),function(){"use strict";function ConfigSrv(){var conf={},me={set:function(conf_){conf=angular.extend({},conf_)},_update:function(conf_){angular.extend(conf,conf_)},get:function(){return conf||{}}};return me}angular.module("SportsensusApp").factory("ConfigSrv",ConfigSrv)}(),function(){"use strict";function ParamsSrv($rootScope,$http,$q,ApiSrv,ConfigSrv){function setParamsWatchers(){}function prepareParams(){function getElement(id){function recFind(items){var finded;return items.some(function(item){return item.id&&item.id==id?finded=item:item.lists instanceof Array&&(finded=recFind(item.lists)),!!finded}),finded}var item=recFind(translations.pages);if(item)return item}function refreshCount(newValue,oldValue){var audience=getSelectedAudience();ApiSrv.getCount(audience)}["demography","consume","regions","sport","interest","rooting","involve","image"].forEach(function(type){parameters[type]=getElement(type)});var allSports={football:1,hockey:2,basketball:3,car:4,figskating:5,biathlon:6,boxing:7,tennis:8},colorGenerator=d3.scale.category10();parameters.sport.lists.forEach(function(item){item.key=allSports[item.id],item.chartColor=colorGenerator(allSports[item.id])}),parameters.interest.lists.forEach(function(item){item.chartColor=colorGenerator(item.id)}),$rootScope.$watch(function(){return[parameters.demography,parameters.consume,parameters.regions]},refreshCount,!0)}function getSelectedParamsRec(item){if(!item.lists.every(function(subitem){return!subitem.lists})){var res={};return item.lists.forEach(function(subitem){var subitemList=getSelectedParamsRec(subitem);subitemList&&(res[subitem.id]=subitemList)}),item.interested&&(res.interested=!0),Object.keys(res).length?res:void 0}var selectedA=item.lists.filter(function(subitem){return subitem.selected}).map(function(subitem){return subitem.id});if(selectedA.length)return selectedA.length?selectedA:void 0}function getSelectedParams(itemName){return getSelectedParamsRec(parameters[itemName])}function getSelectedAudience(){return{demography:getSelectedParams("demography"),regions:getSelectedParams("regions"),consume:getSelectedParams("consume")}}function getParams(){return padamsDefer.promise}var padamsDefer=$q.defer(),parameters={},translations=null;ApiSrv.getTranslations().then(function(data){translations=data,prepareParams(),setParamsWatchers(),padamsDefer.resolve(parameters)},function(){padamsDefer.reject()});var me={getParams:getParams,getSelectedParams:getSelectedParams,getSelectedAudience:getSelectedAudience};return me}angular.module("SportsensusApp").factory("ParamsSrv",ParamsSrv),angular.module("SportsensusApp").run(["ParamsSrv",function(ParamsSrv){}]),ParamsSrv.$inject=["$rootScope","$http","$q","ApiSrv","ConfigSrv"]}(),function(){"use strict";function headerDir($rootScope,ApiSrv){return{restrict:"E",scope:{},templateUrl:"/views/widgets/header/header.html",link:function($scope,$el,attrs){},controller:["$scope","$routeParams","$location","$window","ApiSrv",function($scope,$routeParams,$location,$window,ApiSrv){$scope.loggedIn=!1,$scope.menu=[{name:"О проекте",visible:function(){return!$scope.loggedIn}},{name:"Зарегистрироваться",visible:function(){return!$scope.loggedIn}},{name:"Войти",visible:function(){return!$scope.loggedIn},onClick:function(){$scope.setPath("/login/")}},{name:"Техническая поддержка",visible:function(){return!$scope.loggedIn},onClick:function(){$scope.setPath("/infobox/")}},{name:"Получить информацию",visible:function(){return $scope.loggedIn}},{name:"Проанализировать",visible:function(){return $scope.loggedIn}},{name:"Спланировать",visible:function(){return $scope.loggedIn}},{name:"Оценить",visible:function(){return $scope.loggedIn}}],$scope.$watch(function(){return ApiSrv.getUser().sid},function(sid){$scope.loggedIn=!!sid},!0),$scope.setPath=function(path){$location.path(path)},$scope.logout=function(){ApiSrv.logout(),$scope.setPath("/")}}]}}angular.module("SportsensusApp").directive("headerDir",headerDir),headerDir.$inject=["$rootScope","ApiSrv"]}(),function(){"use strict";function homeDir($rootScope){return{restrict:"E",scope:{},templateUrl:"/views/widgets/home/home.html",link:function($scope,$el,attrs){},controller:["$scope","$routeParams","$location","$window",function($scope,$routeParams,$location,$window){}]}}angular.module("SportsensusApp").directive("homeDir",homeDir),homeDir.$inject=["$rootScope"]}(),function(){"use strict";function infoboxDir($rootScope){return{restrict:"E",scope:{},templateUrl:"/views/widgets/infobox/infobox.html",link:function($scope,$el,attrs){},controller:["$scope","$routeParams","$location","$window","ParamsSrv",function($scope,$routeParams,$location,$window,ParamsSrv){$scope.audienceCountText=null,$scope.audienceMenu=[{id:"demography",text:"Социальная демография"},{id:"consume",text:"Потребительское поведение"},{id:"regions",text:"География"}],$scope.sportinfoMenu=[{id:"sport",text:"Спорт"},{id:"interestGraph",text:"Степень интереса"},{id:"rooting",text:"Сила боления"},{id:"involve",text:"Причастность к видам спорта"},{id:"imageGraph",text:"Восприятие видов спорта"}],$scope.pages={},["imageGraph"].forEach(function(page){$scope.pages[page]={id:page}}),ParamsSrv.getParams().then(function(params){$scope.parameters=params}),$scope.activePage=null,$scope.activeMenuItem=null,$scope.setActiveMenuItem=function(item){$scope.activeMenuItem=item,$scope.activePage=item},$scope.getAllSubchildren=function(item){if(item){var finalItems=[];return!item.lists||item.lists.every(function(subitem){return!subitem.lists})?finalItems.push(item):item.lists.forEach(function(subitem){finalItems=finalItems.concat($scope.getAllSubchildren(subitem))}),finalItems}},$scope.pathClick=function(){},$scope.checkButtonClick=function(){$scope.activeMenuItem&&"image"==$scope.activeMenuItem.id&&($scope.activePage=$scope.pages.imageGraph)},$scope.$on("ApiSrv.countError",function(){$scope.audienceCountText="Болельщики: ошибка загрузки"}),$scope.$on("ApiSrv.countLoaded",function(event,result){result.is_valid_count?$scope.audienceCountText="Болельщики: "+result.audience_count.toLocaleString():$scope.audienceCountText="Болельщики: недостаточно данных"}),$scope.selectCheckbox=function(collection,item){ParamsSrv.getParams().then(function(params){}),"radio"==collection.type&&angular.forEach(collection.items,function(_item){item!=_item&&(_item.selected=!1)})}}]}}angular.module("SportsensusApp").directive("infoboxDir",infoboxDir),infoboxDir.$inject=["$rootScope"]}(),function(){"use strict";function loginDir($rootScope){return{restrict:"E",scope:{},templateUrl:"/views/widgets/login/login.html",link:function($scope,$el,attrs){},controller:["$scope","$routeParams","$location","$window","ApiSrv",function($scope,$routeParams,$location,$window,ApiSrv){$scope.vm={login:null,password:null,error:null},$scope.login=function(){$scope.vm.dataLoading=!0,$scope.vm.error=null,ApiSrv.auth($scope.vm).then(function(){$location.path("/infobox/"),$scope.vm.dataLoading=!1},function(){$scope.vm.dataLoading=!1,$scope.vm.error="Неправильный логин или пароль"})}}]}}angular.module("SportsensusApp").directive("loginDir",loginDir),loginDir.$inject=["$rootScope"]}(),function(){"use strict";function legendDir($rootScope){return{restrict:"E",scope:{legend:"="},templateUrl:"/views/widgets/charts/legend/legend.html",link:function($scope,$el,attrs){},controller:["$scope","$routeParams","$location","$window","ApiSrv",function($scope){$scope.itemClick=function(item){item.selected=!item.selected}}]}}angular.module("SportsensusApp").directive("legendDir",legendDir),legendDir.$inject=["$rootScope"]}(),function(){"use strict";function radarDir($rootScope){return{restrict:"E",scope:{chart:"="},templateUrl:"/views/widgets/charts/radar/radar.html",link:function($scope,$el,attrs){$scope.el=$el,$scope.$watch("chart",$scope.redrawChart)},controller:["$scope",function($scope){$scope.redrawChart=function(){if(!$scope.chart||!$scope.chart.data||!$scope.chart.options)return void $scope.el.empty();var margin={top:50,right:120,bottom:100,left:120},width=700-margin.left-margin.right,height=700-margin.top-margin.bottom,options={w:width,h:height,margin:margin};options=angular.extend({},$scope.chart.options,options),RadarChart($scope.el[0],$scope.chart.data,options)}}]}}angular.module("SportsensusApp").directive("radarDir",radarDir),radarDir.$inject=["$rootScope"]}(),function(){"use strict";function stackedBarDir($rootScope){return{restrict:"E",scope:{chart:"="},templateUrl:"/views/widgets/charts/stackedBar/stackedBar.html",link:function($scope,$el,attrs){$scope.el=$el,$scope.$watch("chart",$scope.redrawChart)},controller:["$scope",function($scope){$scope.redrawChart=function(){if(!$scope.chart||!$scope.chart.data||!$scope.chart.options)return void $scope.el.empty();var chartData=$scope.chart.data,ctx=($scope.chart.options,$scope.el.find("canvas")[0].getContext("2d"));new Chart(ctx).StackedBar(chartData,{showLabels:!1,showTooltips:!0,stacked:!0,tooltipHideZero:!0})}}]}}angular.module("SportsensusApp").directive("stackedBarDir",stackedBarDir),stackedBarDir.$inject=["$rootScope"]}(),function(){"use strict";function imageGraphCrtl($scope,ParamsSrv,ApiSrv){function requestGraph(){var audience=ParamsSrv.getSelectedAudience(),sports={};$scope.parameters.sport.lists.forEach(function(list){sports[list.id]={interested:!0}});var images=$scope.parameters.image.lists.map(function(list){return list.id}),sportimage={sport:sports,image:images};ApiSrv.getImageGraph(audience,sportimage).then(function(graphData){$scope.prepareData(graphData),$scope.prepareLegend()},function(){})}ParamsSrv.getParams().then(function(params){$scope.parameters=params,requestGraph()}),$scope.legend=[],$scope.prepareLegend=function(){var selected=!1,legend=$scope.parameters.sport.lists.map(function(list){return selected=selected||list.interested,{id:list.id,name:list.name,color:list.chartColor,selected:list.interested}});selected||legend.forEach(function(item){item.selected=!0}),$scope.legend=legend,$scope.$watch("legend",$scope.updateGraph,!0)},$scope.prepareData=function(data){var images={};$scope.parameters.image.lists.forEach(function(list){images[list.id]={id:list.id,name:list.name,count:0}});var sports={};$scope.parameters.sport.lists.forEach(function(list){sports[list.key]=angular.merge({data:angular.merge({},images)},list)});var legendIndexes={};data.legends.forEach(function(item,index){legendIndexes[item.name]=index}),data.data.forEach(function(item){var sportId=item.legend[legendIndexes.sport],imageId=item.legend[legendIndexes.sportimage];sports[sportId].data[imageId].count+=item.count},this),$scope.sportDatas={},Object.keys(sports).forEach(function(sportId){var sport=sports[sportId],maxValue=0,axisData=[];Object.keys(sport.data).forEach(function(imageId){var value=sport.data[imageId].count/1e3/1e3;value=Math.round(10*value)/10,axisData.push({axis:images[imageId].name,value:value}),maxValue=Math.max(maxValue,value)},this);var sportData={axisData:axisData,maxValue:maxValue};$scope.sportDatas[sport.id]=sportData},this)},$scope.updateGraph=function(){var chartData=[],localColors=[],maxValue=0;$scope.legend.forEach(function(item){item.selected&&(chartData.push($scope.sportDatas[item.id].axisData),localColors.push(item.color),maxValue=Math.max(maxValue,$scope.sportDatas[item.id].maxValue))}),maxValue=5*Math.ceil(maxValue/5);var radarChartOptions={maxValue:maxValue,levels:5,wrapWidth:100,labelFactor:1.32,roundStrokes:!0,color:function(i){return localColors[i]}};chartData&&chartData.length?$scope.chart={data:chartData,options:radarChartOptions}:$scope.chart=null}}angular.module("SportsensusApp").controller("imageGraphCrtl",imageGraphCrtl),imageGraphCrtl.$inject=["$scope","ParamsSrv","ApiSrv"]}(),function(){"use strict";function interestGraphCrtl($scope,ParamsSrv,ApiSrv){function requestGraph(){var audience=ParamsSrv.getSelectedAudience(),sports={};$scope.parameters.sport.lists.forEach(function(list){sports[list.id]={interested:!0}});var interests=$scope.parameters.interest.lists.map(function(list){return list.id}),sportinterest={sport:sports,interest:interests};ApiSrv.getInterestGraph(audience,sportinterest).then(function(graphData){$scope.prepareData(graphData),$scope.prepareLegends()},function(){})}ParamsSrv.getParams().then(function(params){$scope.parameters=params,requestGraph()}),$scope.showCharts=!1,$scope.legend=[],$scope.prepareLegends=function(){var selected=!1,sportLegend=$scope.parameters.sport.lists.map(function(list){return selected=selected||list.interested,{id:list.id,key:list.key,name:list.name,color:"#555555",selected:list.interested}});selected||sportLegend.forEach(function(item){item.selected=!0});var interestLegend=$scope.parameters.interest.lists.map(function(list){return selected=selected||list.selected,{id:list.id,name:list.name,color:list.chartColor,selected:list.selected}}).reverse();selected||interestLegend.forEach(function(item){item.selected=!0}),$scope.sportLegend=sportLegend,$scope.$watch("sportLegend",$scope.updateGraph,!0),$scope.interestLegend=interestLegend,$scope.$watch("interestLegend",$scope.updateGraph,!0)},$scope.prepareData=function(data){var interests={};$scope.parameters.interest.lists.forEach(function(list){interests[list.id]={id:list.id,name:list.name,count:0}});var sports={};$scope.parameters.sport.lists.forEach(function(list){sports[list.key]=angular.merge({data:angular.merge({},interests)},list)});var legendIndexes={};data.legends.forEach(function(item,index){legendIndexes[item.name]=index}),data.data.forEach(function(item){var sportId=item.legend[legendIndexes.sport],interestId=item.legend[legendIndexes.sportinterest];sports[sportId].data[interestId].count+=item.count},this),Object.keys(sports).forEach(function(sportId){var sport=sports[sportId];Object.keys(sport.data).forEach(function(imageId){var value=sport.data[imageId].count/1e3/1e3;value=Math.round(10*value)/10,sport.data[imageId].count=value},this)},this),$scope.sportDatas=sports},$scope.updateGraph=function(){var useBars=!0,showInterest=!1,showNotInterest=!1,interests=[],interestsO={};$scope.interestLegend.forEach(function(interest){interest.selected&&(interests.push(interest),interestsO[interest.id]=interest,3==interest.id&&(useBars=!1),interest.id<3&&(showInterest=!0),interest.id>3&&(showNotInterest=!0))});var sports=[];$scope.sportLegend.forEach(function(sport){if(sport.selected){var chartData={labels:[],datasets:[]};if(useBars){var twoCols=showInterest&&showNotInterest,interestDs={label:[],fillColor:[],data:[]},notInterestDs={label:[],fillColor:[],data:[]};[[interestsO[5],interestDs],[interestsO[1],interestDs],[interestsO[4],notInterestDs],[interestsO[2],notInterestDs]].forEach(function(item){item[0]?(item[1].label.push(item[0].name),item[1].fillColor.push(item[0].color),item[1].data.push($scope.sportDatas[sport.key].data[item[0].id].count)):twoCols&&(item[1].label.push(""),item[1].fillColor.push(""),item[1].data.push(0))}),chartData.labels.push(""),twoCols&&chartData.labels.push(""),interestDs.label.length&&chartData.datasets.push(interestDs),notInterestDs.label.length&&chartData.datasets.push(notInterestDs)}else{var dataDs={label:[],fillColor:[],data:[]},emptyDs={label:[],fillColor:[],data:[]};interests.forEach(function(interest){dataDs.label.push(interest.name),dataDs.fillColor.push(interest.color),dataDs.data.push($scope.sportDatas[sport.key].data[interest.id].count),emptyDs.label.push(interest.name),emptyDs.fillColor.push(interest.color),emptyDs.data.push(0),chartData.labels.push("")}),chartData.datasets.push(dataDs),chartData.datasets.push(emptyDs)}sports.push({sport:sport,chartData:{data:chartData,options:{}}})}}),$scope.showCharts=sports.length&&interests.length,$scope.charts=sports}}angular.module("SportsensusApp").controller("interestGraphCrtl",interestGraphCrtl),interestGraphCrtl.$inject=["$scope","ParamsSrv","ApiSrv"]}();