angular.module("SportsensusApp",["ngRoute","ngCookies","Views"]).config(["$locationProvider","$routeProvider",function($locationProvider,$routeProvider){$locationProvider.hashPrefix("!"),$routeProvider.when("/",{template:"<home-dir></home-dir>"}).when("/infobox/",{template:"<infobox-dir></infobox-dir>"}).when("/login/",{template:"<login-dir></login-dir>"}).otherwise("/")}]).run(["ConfigSrv",function(ConfigSrv){var config=window.appConfig;ConfigSrv.set(config)}]),function(){"use strict";function ApiSrv($rootScope,$http,$q,$cookies,ConfigSrv){function readSidCookie(){return $cookies.get(sidCookieName)}function writeSidCookie(sid){$cookies.put(sidCookieName,sid)}function clearUser(){sid=null,userRights=null}function setUser(_sid,rights){sid=_sid,userRights=rights,writeSidCookie(sid),getTranslations()}function getUser(){return{sid:sid,userRights:userRights}}function prepareRequestData(method,params){var data={jsonrpc:"2.0",method:method,params:params,id:"id"};return data}function auth(par){var d=$q.defer(),params={login:par.login,password:par.password},data=prepareRequestData("auth",params);return $http.post(url,data).then(function(response){response.data.result?(setUser(response.data.result.sid,response.data.result.acl),d.resolve(response)):(clearUser(),d.reject(response))},function(response){clearUser(),d.reject(response)}),d.promise}function checkSession(_sid){var d=$q.defer(),checkedSid=_sid||sid,params={sid:checkedSid},data=prepareRequestData("check_session",params);return $http.post(url,data).then(function(response){response.data.result&&response.data.result.exist?(setUser(checkedSid,response.data.result.acl),d.resolve(response)):(clearUser(),d.reject(response))},function(response){clearUser(),d.reject(response)}),d.promise}function logout(){var d=$q.defer(),params={sid:sid},data=prepareRequestData("logout",params);return $http.post(url,data).then(function(response){clearUser(),response.data.result&&response.data.result.deleted?d.resolve(response):d.reject(response)},function(response){clearUser(),d.reject(response)}),d.promise}function getTranslations(){function loadTranslations(){var data=prepareRequestData("get_translations",{sid:sid});return $http.post(url,data).then(function(result){result.data&&result.data.result&&result.data.result.data?translationsDefer.resolve(result.data.result.data):translationsDefer.reject()},function(result){translationsDefer.reject()})}return translationsDefer||(translationsDefer=$q.defer()),!translationsLoaded&&sid&&loadTranslations(),translationsDefer.promise}function getCount(audience){var d=$q.defer();$rootScope.$broadcast("ApiSrv.countLoading");var data=prepareRequestData("audienceCount",{sid:sid,audience:audience});return $http.post(url,data).then(function(response){response.data.result?(d.resolve(response.data.result),$rootScope.$broadcast("ApiSrv.countLoaded",response.data.result)):(d.reject(response),$rootScope.$broadcast("ApiSrv.countError",response))},function(response){d.reject(response),$rootScope.$broadcast("ApiSrv.countError",response)}),d.promise}var userRights,proxyURL=ConfigSrv.get().proxyURL||"",url=proxyURL+ConfigSrv.get().apiUrl,sidCookieName="sportsensus_sid",sid=null;checkSession(readSidCookie());var translationsDefer,translationsLoaded=!1,me={getUser:getUser,auth:auth,checkSession:checkSession,logout:logout,getCount:getCount,getTranslations:getTranslations};return me}angular.module("SportsensusApp").factory("ApiSrv",ApiSrv),angular.module("SportsensusApp").run(["ApiSrv",function(ApiSrv){}]),ApiSrv.$inject=["$rootScope","$http","$q","$cookies","ConfigSrv"]}(),function(){"use strict";function ConfigSrv(){var conf={},me={set:function(conf_){conf=angular.extend({},conf_)},_update:function(conf_){angular.extend(conf,conf_)},get:function(){return conf||{}}};return me}angular.module("SportsensusApp").factory("ConfigSrv",ConfigSrv)}(),function(){"use strict";function ParamsSrv($rootScope,$http,$q,ApiSrv,ConfigSrv){function setParamsWatchers(){}function prepareParams(){function getElement(id){function isNumber(n){return!isNaN(parseFloat(n))&&isFinite(n)}function recFillTranslations(item){item.lists instanceof Array&&(item.lists.every(function(subitem){return isNumber(subitem)})?item.lists=item.lists.map(function(subitem){return{id:subitem,name:translations.translates[item.id+"_"+subitem]}}):item.lists.forEach(function(subitem){recFillTranslations(subitem)}))}function recFind(items){var finded;return items.some(function(item){return item.id&&item.id==id?finded=item:item.lists instanceof Array&&(finded=recFind(item.lists)),!!finded}),finded}var item=recFind(translations.pages);if(item)return recFillTranslations(item),item}function refreshCount(newValue,oldValue){var audience=getAudience();ApiSrv.getCount(audience)}["demography","consume","regions","sport","interest","rooting","involve","image"].forEach(function(type){parameters[type]=getElement(type)}),$rootScope.$watch(function(){return[parameters.demography,parameters.consume,parameters.regions]},refreshCount,!0)}function getAudience(){function getParamsRec(item){if(!item.lists.every(function(subitem){return!subitem.lists})){var res={};return item.lists.forEach(function(subitem){var subitemList=getParamsRec(subitem);subitemList&&(res[subitem.id]=subitemList)}),Object.keys(res).length?res:void 0}var selectedA=item.lists.filter(function(subitem){return subitem.selected}).map(function(subitem){return subitem.id});if(selectedA.length)return selectedA.length?selectedA:void 0}var demography=getParamsRec(parameters.demography),consume=getParamsRec(parameters.consume);return{demography:demography,consume:consume};var demography,consume}function getParams(){return padamsDefer.promise}var padamsDefer=$q.defer(),parameters={},translations=null;ApiSrv.getTranslations().then(function(data){translations=data,prepareParams(),setParamsWatchers(),padamsDefer.resolve(parameters)},function(){padamsDefer.reject()});var me={getParams:getParams,getDemography:function(){return parameters.demography},getConsume:function(){return parameters.consume},getSport:function(){return parameters.sport},getInterest:function(){return parameters.interest},getRooting:function(){return parameters.rooting},getInvolve:function(){return parameters.involve},getImage:function(){return parameters.image}};return me}angular.module("SportsensusApp").factory("ParamsSrv",ParamsSrv),angular.module("SportsensusApp").run(["ParamsSrv",function(ParamsSrv){}]),ParamsSrv.$inject=["$rootScope","$http","$q","ApiSrv","ConfigSrv"]}(),function(){"use strict";function headerDir($rootScope,ApiSrv){return{restrict:"E",scope:{},templateUrl:"/views/widgets/header/header.html",link:function($scope,$el,attrs){},controller:["$scope","$routeParams","$location","$window","ApiSrv",function($scope,$routeParams,$location,$window,ApiSrv){$scope.loggedIn=!1,$scope.$watch(function(){return ApiSrv.getUser().sid},function(sid){$scope.loggedIn=!!sid},!0),$scope.setPath=function(path){$location.path(path)},$scope.logout=function(){ApiSrv.logout(),$scope.setPath("/")}}]}}angular.module("SportsensusApp").directive("headerDir",headerDir),headerDir.$inject=["$rootScope","ApiSrv"]}(),function(){"use strict";function homeDir($rootScope){return{restrict:"E",scope:{},templateUrl:"/views/widgets/home/home.html",link:function($scope,$el,attrs){},controller:["$scope","$routeParams","$location","$window",function($scope,$routeParams,$location,$window){}]}}angular.module("SportsensusApp").directive("homeDir",homeDir),homeDir.$inject=["$rootScope"]}(),function(){"use strict";function infoboxDir($rootScope){return{restrict:"E",scope:{},templateUrl:"/views/widgets/infobox/infobox.html",link:function($scope,$el,attrs){},controller:["$scope","$routeParams","$location","$window","ParamsSrv",function($scope,$routeParams,$location,$window,ParamsSrv){$scope.audienceCountText=null,$scope.audienceMenu=[{id:"demography",text:"Социальная демография"},{id:"consume",text:"Потребительское поведение"},{id:"regions",text:"География"}],$scope.sportinfoMenu=[{id:"sport",text:"Спорт"},{id:"interest",text:"Степень интереса"},{id:"rooting",text:"Сила боления"},{id:"involve",text:"Причастность к видам спорта"},{id:"image",text:"Восприятие видов спорта"}],ParamsSrv.getParams().then(function(params){$scope.parameters=params}),$scope.activeMenuItem=null,$scope.setActiveMenuItem=function(item){$scope.activeMenuItem=item},$scope.getAllSubchildren=function(item){if(item){var finalItems=[];return!item.lists||item.lists.every(function(subitem){return!subitem.lists})?finalItems.push(item):item.lists.forEach(function(subitem){finalItems=finalItems.concat($scope.getAllSubchildren(subitem))}),finalItems}},$scope.pathClick=function(){},$scope.checkButtonClick=function(){},$scope.$on("ApiSrv.countError",function(){$scope.audienceCountText="Болельщики: НЕДОСТАТОЧНО ДАННЫХ"}),$scope.$on("ApiSrv.countLoaded",function(event,result){result.is_valid_count?$scope.audienceCountText="Болельщики: "+result.audience_count:$scope.audienceCountText="Болельщики: НЕДОСТАТОЧНО ДАННЫХ "+result.audience_count}),$scope.selectCheckbox=function(collection,item){ParamsSrv.getParams().then(function(params){}),"radio"==collection.type&&angular.forEach(collection.items,function(_item){item!=_item&&(_item.selected=!1)})}}]}}angular.module("SportsensusApp").directive("infoboxDir",infoboxDir),infoboxDir.$inject=["$rootScope"]}(),function(){"use strict";function loginDir($rootScope){return{restrict:"E",scope:{},templateUrl:"/views/widgets/login/login.html",link:function($scope,$el,attrs){},controller:["$scope","$routeParams","$location","$window","ApiSrv",function($scope,$routeParams,$location,$window,ApiSrv){$scope.vm={login:null,password:null,error:null},$scope.login=function(){$scope.vm.dataLoading=!0,$scope.vm.error=null,ApiSrv.auth($scope.vm).then(function(){$location.path("/infobox/"),$scope.vm.dataLoading=!1},function(){$scope.vm.dataLoading=!1,$scope.vm.error="Неправильный логин или пароль"})}}]}}angular.module("SportsensusApp").directive("loginDir",loginDir),loginDir.$inject=["$rootScope"]}();